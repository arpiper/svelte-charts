<div id="{{ toolTipId }}" class="tooltip-container">
</div>

<script>
var d3 = require("d3")
var $ = require("jquery")

export default {
  data () {
    return {
      chartData: {},
    }
  },
  computed: {
    toolTipId (chartData) {
      return `${chartData.selector}-tooltip`
    }
  },
  methods: {
    addToolTip () {
      let data = this.get("chartData")
      let svg = d3.select(`#${data.selector}`).select("g")
      let tip = svg.append("g")
        .append("foreignObject")
          .attr("class", "fo-tooltip-container")
      tip = this.createTipStyle(tip)

      if (data.type === "line" || data.type === "bar") {
        let tipbars = this.barToolTip(tip, svg)
      } else if (data.type === "pie") {
        let tipbars = this.pieToolTip(tip, svg)
      }
      /*
      let tipbars = svg.append("g").selectAll("rect").data(data.dataset.x)
        .enter().append("rect")
          .attr("class", "tooltip-bar")
          .attr("width", 20)
          .attr("x", (d) => this.getXCoords(data.scales.x, d) - 10)
          .attr("height", data.size.adj_height)
          .style("opacity", 0)
          .on("mouseover", (d,i,n) => {
            let x = this.getXCoords(data.scales.x, d)
            let y = this.getYCoords(data.scales.y, data.dataset.y[i])
            let e = tip.select(".fo-tooltip")
            e.attr("id", `tooltip-data-${i}`)
            e.text(`${d}:${data.dataset.y[i]}`)
            e = document.getElementById(`tooltip-data-${i}`)
            tip.attr("x", x - (e.offsetWidth / 2))
              .attr("y", y - (e.offsetHeight * 2))
              .attr("opacity", 1)
              .attr("width", e.offsetWidth)
              .attr("height", e.offsetHeight)
            e.style.visibility = "visible"
          })
          .on("mouseout", (d,i,n) => {
            n[i].style['opacity'] = 0
            tip.attr('opacity', 0)
          })
          */
      tip.on("mouseover", () => tip.attr("opacity", 1))
        .on("mouseout", () => tip.attr("opacity", 0))
        
      return tip
    },
    barToolTip (tip, svg) {
      let data = this.get("chartData")
      let tipbars = svg.append("g").selectAll("rect").data(data.dataset.x)
        .enter().append("rect")
          .attr("class", "tooltip-bar")
          .attr("width", 20)
          .attr("x", (d) => this.getXCoords(data.scales.x, d) - 10)
          .attr("height", data.size.adj_height)
          .style("opacity", 0)
          .on("mouseover", (d,i,n) => {
            let x = this.getXCoords(data.scales.x, d)
            let y = this.getYCoords(data.scales.y, data.dataset.y[i])
            let e = tip.select(".fo-tooltip")
            e.attr("id", `tooltip-data-${i}`)
            e.text(`${d}:${data.dataset.y[i]}`)
            e = document.getElementById(`tooltip-data-${i}`)
            tip.attr("x", x - (e.offsetWidth / 2))
              .attr("y", y - (e.offsetHeight * 2))
              .attr("opacity", 1)
              .attr("width", e.offsetWidth)
              .attr("height", e.offsetHeight)
            e.style.visibility = "visible"
          })
          .on("mouseout", (d,i,n) => {
            n[i].style['opacity'] = 0
            tip.attr('opacity', 0)
          })
      return tipbars
    },
    pieToolTip (tip, svg) {
      let data = this.get("chartData")
      console.log(svg)
      let tipbars = svg.selectAll(".pie-slice")
        .on("mouseover", (d,i) => { 
          console.log('hovertooltip pie')
          return d
        })
    },
    getElement (el) {
      let e = document.createElement(el)
      e.setAttribute("class", "fo-tooltip")
      return e
    },
    createTipStyle (tipFO) {
      let style = document.createElement("style")
      tipFO.append("xhtml:head").node().appendChild(style)
      style.sheet.insertRule(
        `.fo-tooltip:after {
          display: block;
          content: "";
          position: absolute;
          bottom: -10px;
          left: calc(50% - 10px);
          border-width: 10px 10px 0;
          border-style: solid;
          border-color: rgba(0, 0, 0, 0.8) transparent;
          width: 0;
        }`,
      0)
      style.sheet.insertRule(
        `.fo-tooltip {
          display: inline-block;
          color: white;
          font-size: 10px;
          visibility: hidden;
          padding: 2px 5px;
          text-align: center;
          background-color: rgba(0,0,0,0.8);
        }`,
      0)
      style.sheet.insertRule(
        `.fo-tooltip-cantainer {
          position: relative;
          text-align: center;
        }`,
      0)
      style.sheet.insertRule(
        `body {
          width: 100%;
          height: 100%;
          margin: 0;
        }`,
      0)
      tipFO.node()
        .appendChild(document.createElement("body"))
        .appendChild(this.getElement("span"))
      return tipFO
    },
    getXCoords (xfunc, val) {
      let x = xfunc(val)
      if (xfunc.step) {
        x += xfunc.step() / 2
      }
      return x
    },
    getYCoords (yfunc, val) {
      let y = yfunc(val)
      if (yfunc.step) {
        y += yfunc.step() / 2
      }
      return y
    }
  },
  oncreate () {
    let d = this.get("chartData")
    console.log('hovertootltip', d)
    if (d.options.hovertooltip) {
      this.addToolTip()
    }
  }
}
</script>

<style>
.tooltip-container {
  position: relative;
}
.tooltip {
  position: absolute;
  z-index: 100;
  background-color: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px;
}
/*
 * little triangle 
 */
.tooltip:after {
  display: block;
  content: "";
  position: absolute;
  bottom: -10px;
  left: calc(50% - 10px);
  border-width: 10px 10px 0;
  border-style: solid;
  border-color: rgba(0, 0, 0, 0.8) transparent;
  width: 0;
}
.tooltip-bar {
  fill-opacity: 0.25;
  stroke-width: 2px;
  stroke: black;
  z-index: 1000;
}
</style>
