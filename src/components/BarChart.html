<div class="bar-chart-container">
  {{ yield }}
</div>

<script>
import HoverToolTip from "./HoverToolTip.html"
var d3 = require("d3")

export default {
  data () {
    return {
      dataset: {},
      size: {},
      selector: "",
      svg: undefined,
      scales: undefined,
      axes: undefined,
      barWidth: 20,
      options: {},
    }
  },
  computed: {
    hoverData (dataset, scales, size, barWidth, svg, selector) {
      return {
        dataset: dataset,
        scales: scales,
        size: size,
        selector: selector,
        hoverWidth: barWidth,
      }
    },
  },
  methods: {
    createAxes () {
      let size, yaxis, xaxis, d, svg, scales, opts
      svg = this.get("svg")
      d = this.get("dataset")
      size = this.get("size")
      scales = this.get("scales")
      opts = this.get("options")
      
      yaxis = d3.axisLeft(scales.y)
          .ticks(opts.ticks.count_y)
          .tickFormat((d) => `${opts.ticks.format.y.pre}${d}${opts.ticks.format.y.suf}`)
      xaxis = d3.axisBottom(scales.x)
          .ticks(opts.ticks.count_x)
          .tickFormat((d) => `${opts.ticks.format.x.pre}${d}${opts.ticks.format.x.suf}`)

      svg = svg.append("g").attr("transform", `translate(${size.margin}, ${size.margin})`)
      svg.append("g")
        .attr("class", "y-axis")
        .call(yaxis)
      svg.append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(0, ${size.adj_height})`)
        .call(xaxis)

      this.set({
        axes: {x: xaxis, y: yaxis},
        svg: svg
      })
    },
    drawBars: function (xset, yset, color="green") {
      let svg = this.get("svg")
      //let data = this.get("dataset")
      let size = this.get("size")
      let scales = this.get("scales")
      let barwidth = this.get("barWidth")
      svg = svg.append("g").selectAll("rect").data(xset)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("fill", color)
          .attr("width", barwidth)
          .attr("height", (d,i) => size.adj_height - scales.y(yset[i]))
          .attr("y", (d,i) => scales.y(yset[i]))
      if (scales.x.step) { // adjust bars for a scaleBand
        svg.attr("x", (d) => scales.x(d) + (scales.x.step() / 2) - (barwidth / 2))
      } else {
        svg.attr("x", (d) => scales.x(d) - (barwidth / 2))
      }
    },
    drawBarStack: function (xset, yset) {
      let svg = this.get("svg")
      let size = this.get("size")
      let scales = this.get("scales")
      let barwidth = this.get("barWidth")
      let g = svg.append("g")
          .attr("transform", `translate(${0},${0})`)
        .selectAll("g").data(xset)
          .enter().append("g")
            .attr("class", "bar-stack")
      let i = 0
      for (let k of Object.keys(yset)) {
        g.append("rect")
          .attr("class", "bar-segment")
          .attr("fill", d3schemeCategory10[i])
          .attr("widht", barwidth)
          .attr("height", (d,i) => size.adj_height - scales.y(yset[k][i]))
          .attr("y", (d,i) => scales.y(yset[k][i]))
          .attr("x", (d) => scales.x(d) + (scales.x.step() / 2) - (barwidth  / 2))
      }
    }
  },
  oncreate () {
    let opts = this.get("options")
    let selector = this.get("selector")
    let data = this.get("dataset")
    this.set({
      svg: d3.select(`#${selector}`)
    })
    if (opts.stacked) {
      this.drawBarStack()
      for (let y of Object.values(data.y)) {
      }
    } else {
      this.createAxes()
      this.drawBars(data.x, data.y)
    }
    /*
    if (!opts.show_zeroes) {
      let d = this.get("dataset")
      let non_zero = d.y.map((v,i) => {
        return {x:d.x[i], y:v}
      }).filter((v,i) => {
        return v.y !== 0
      })
      let non_zero_data = {x:[], y:[]}
      non_zero.forEach((v) => {
        non_zero_data.x.push(v.x)
        non_zero_data.y.push(v.y)
      })
      //console.log(d,non_zero, non_zero_data)
      if (!opts.ticks.user_set) {
        opts.ticks.count_x = non_zero_data.x.length
        opts.ticks.count_y = non_zero_data.y.length
      }
      this.set({dataset: non_zero_data, options: opts})
    }
    */
    
  },
  components: {
    HoverToolTip
  }
}
</script>

<style>
</style>
